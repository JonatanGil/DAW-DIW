"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const globby = require("globby");
const semver = require("semver");
const utils_fs_1 = require("@hint/utils-fs");
const utils_debug_1 = require("@hint/utils-debug");
const utils_string_1 = require("@hint/utils-string");
const is_full_package_name_1 = require("./is-full-package-name");
const load_package_1 = require("./load-package");
const load_hint_package_1 = require("./load-hint-package");
const require_package_1 = require("./require-package");
const has_multiple_resources_1 = require("./has-multiple-resources");
const to_absolute_paths_1 = require("../config/to-absolute-paths");
const enums_1 = require("./enums");
const resource_error_1 = require("./resource-error");
const debug = utils_debug_1.debug(__filename);
/** Cache of resource builders, indexex by resource Id. */
const resources = new Map();
const moduleNameRegex = /[^']*'([^']*)'/g;
/**
 * Validates if a given package can be used with the current `hint` version
 * by looking at its `peerDependencies`
 */
const isVersionValid = (resourcePath) => {
    try {
        const pkg = load_package_1.loadPackage(resourcePath);
        const hintPkg = load_hint_package_1.loadHintPackage();
        return semver.satisfies(hintPkg.version, pkg.peerDependencies.hint);
    }
    catch (e) {
        // We failed to load the package.json so it's a core resource
        debug(e);
        return true;
    }
};
/** Tries to load a module from `resourcePath`. */
exports.tryToLoadFrom = (resourcePath) => {
    // This is exported so it's easier to stub during tests
    let builder = null;
    /*
     * We could be loading a config file that points to a path (thus a JSON).
     * `require` will try to load `.js`, `.json`, `.node` so it will fail and
     * we have to manually do this
     */
    try {
        const resource = utils_fs_1.loadJSONFile(resourcePath);
        return resource;
    }
    catch (e) {
        debug(`${resourcePath} is not a JSON file, trying to load it normally`);
    }
    try {
        /*
         * The following link has more info on how `require` resolves modules:
         * http://nodejs.org/dist/latest-v8.x/docs/api/modules.html#modules_all_together
         */
        const resource = require_package_1.requirePackage(resourcePath);
        builder = resource.default || resource;
    }
    catch (e) {
        debug(`Can't require ${resourcePath}`);
        /* istanbul ignore else */
        if (e.code === 'MODULE_NOT_FOUND') {
            /*
             * This get the name of the missed module
             * e.g: Cannot find module 'iltorb'
             */
            const exec = moduleNameRegex.exec(e.message);
            const moduleName = exec ? exec[1] : null;
            /*
             * If the module not found is the same as the module
             * we are trying to load, then is ok.
             */
            if (!moduleName || moduleName === resourcePath) {
                return null;
            }
            const errorMessage = `Module ${moduleName} not found when loading ${resourcePath}`;
            // The resourcePath and the module not found are different.
            throw new resource_error_1.ResourceError(errorMessage, enums_1.ResourceErrorStatus.DependencyError);
        }
        throw new resource_error_1.ResourceError(e, enums_1.ResourceErrorStatus.Unknown);
    }
    return builder;
};
/**
 * Get a resource with the given `name` from a path
 * If that path contains a package with multiple resources
 * then get only the one with the given `name`.
 */
const getResource = (source, type, name) => {
    const resource = exports.tryToLoadFrom(source);
    if (!resource) {
        return null;
    }
    if (!has_multiple_resources_1.hasMultipleResources(resource, type)) {
        return resource;
    }
    for (const [key, value] of Object.entries(resource)) {
        if (key === name) {
            return value.default || value;
        }
    }
    return null;
};
// If we are using bundling with webpack we need to "hide" all the requires
const resolvePackage = (modulePath) => {
    let pkgPath;
    /* istanbul ignore if */
    if (process.env.webpack) { // eslint-disable-line no-process-env
        pkgPath = eval(`require.resolve("${modulePath}")`); // eslint-disable-line no-eval
    }
    else {
        pkgPath = require.resolve(modulePath);
    }
    return pkgPath;
};
/**
 * Looks inside the configurations looking for resources.
 */
const generateConfigPathsToResources = (configurations, name, type) => {
    return configurations.reduce((total, configuration) => {
        const basePackagePaths = is_full_package_name_1.isFullPackageName(configuration, enums_1.ResourceType.configuration) ?
            [''] :
            ['@hint/configuration-', 'webhint-configuration-'];
        let result = total;
        for (const basePackagePath of basePackagePaths) {
            const packageName = `${basePackagePath}${configuration}`;
            try {
                const packagePath = path.dirname(resolvePackage(packageName));
                const resourceGlob = is_full_package_name_1.isFullPackageName(name, type) ?
                    name :
                    `{@hint/,webhint-}${type}-${name}`;
                const resourcePackages = globby.sync(`node_modules/${resourceGlob}/package.json`, { absolute: true, cwd: packagePath }).map((pkg) => {
                    return path.dirname(pkg);
                });
                result = result.concat(resourcePackages);
            }
            catch (err) {
                debug(`Package ${packageName} not found`);
            }
        }
        return result;
    }, []);
};
/**
 * Accepts:
 * * Relative paths (./foo)
 * * Unix-style absolute paths (/foo)
 * * Windows-style absolute paths (c:/foo)
 */
const isFilesystemPath = (filename) => {
    return filename[0] === '.' || filename[0] === '/' || filename[1] === ':';
};
/**
 * Looks for a hint resource with the given `name` and tries to load it.
 * If no valid resource is found, it throws an `Error`.
 *
 * By default, the priorities are:
 *
 * 1. core resource
 * 2. `@hint/` scoped package
 * 3. `webhint-` prefixed package
 * 4. external hints
 *
 */
exports.loadResource = (name, type, configurations = [], verifyVersion = false) => {
    debug(`Searching ${name}â€¦`);
    const isSource = isFilesystemPath(name) && fs.existsSync(name); // eslint-disable-line no-sync
    const isPackage = is_full_package_name_1.isFullPackageName(name, type);
    const nameParts = name.split('/');
    let scope = '';
    let unscopedNameParts = nameParts;
    if (isPackage && nameParts[0].startsWith('@')) {
        scope = `${nameParts[0]}/`;
        unscopedNameParts = nameParts.slice(1);
    }
    const packageName = `${scope}${unscopedNameParts[0]}`;
    const resourceName = isSource ?
        name : unscopedNameParts[1] || packageName;
    const key = isPackage || isSource ?
        name :
        `${type}-${name}`;
    // When we check the version we ignore if there was a previous version loaded
    if (resources.has(key) && !verifyVersion) {
        return resources.get(key);
    }
    const configPathsToResources = generateConfigPathsToResources(configurations, packageName, type);
    const currentProcessDir = utils_fs_1.cwd();
    /*
     * We can't use the key for the Official packages neither for the Third party ones because
     * in case that we have a multi-hints packages, the key for the cache has to contain
     * the key for the specific hint, but we need to load the package that contains the hint.
     * i.e.
     * if we want to load the hint `hint-typescript-config/is-valid` the key for the cache
     * has to be `hint-typescript-config/is-valid`.
     * But we need to load the package `hint-typescript-config`.
     */
    let sources;
    if (isSource) {
        sources = [path.resolve(currentProcessDir, name)]; // If the name is direct path to the source we should only check that.
    }
    else if (isPackage) {
        sources = [packageName].concat(configPathsToResources); // If the name is a full package name we should only check that, but look for it in config paths as well.
    }
    else {
        sources = [
            `@hint/${type}-${packageName}`,
            `webhint-${type}-${packageName}`,
            path.normalize(currentProcessDir) // External hints.
        ].concat(configPathsToResources);
    }
    let resource;
    let loadedSource;
    let isValid = true;
    sources.some((source) => {
        const res = getResource(source, type, resourceName);
        if (res && isSource) {
            isValid = true;
            resource = res;
            loadedSource = source;
            return true;
        }
        if (res && !isSource) { // Paths to sources might not have packages and versioning doesn't apply
            debug(`${name} found in ${source}`);
            if (source === currentProcessDir) {
                try {
                    const packageConfig = load_package_1.loadPackage(source);
                    if (!utils_string_1.normalizeIncludes(packageConfig.name, packageName)) {
                        return false;
                    }
                }
                catch (e) {
                    return false;
                }
            }
            if (verifyVersion && !isVersionValid(source)) {
                debug(`Resource ${name} isn't compatible with current hint version`);
                isValid = false;
                return false;
            }
            isValid = true;
            resource = res;
            loadedSource = source;
        }
        return resource;
    });
    if (!isValid) {
        throw new resource_error_1.ResourceError(`Resource ${name} isn't compatible with current hint version`, enums_1.ResourceErrorStatus.NotCompatible);
    }
    if (!resource) {
        debug(`Resource ${name} not found`);
        throw new resource_error_1.ResourceError(`Resource ${name} not found`, enums_1.ResourceErrorStatus.NotFound);
    }
    if (type === enums_1.ResourceType.configuration) {
        resource = to_absolute_paths_1.toAbsolutePaths(resource, resolvePackage(loadedSource));
    }
    resources.set(key, resource);
    return resource;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1yZXNvdXJjZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wYWNrYWdlcy9sb2FkLXJlc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEseUJBQXlCO0FBQ3pCLDZCQUE2QjtBQUU3QixpQ0FBaUM7QUFDakMsaUNBQWlDO0FBRWpDLDZDQUFtRDtBQUNuRCxtREFBK0M7QUFDL0MscURBQXVEO0FBQ3ZELGlFQUEyRDtBQUMzRCxpREFBNkM7QUFDN0MsMkRBQXNEO0FBQ3RELHVEQUFtRDtBQUNuRCxxRUFBZ0U7QUFDaEUsbUVBQThEO0FBQzlELG1DQUE0RDtBQUM1RCxxREFBaUQ7QUFFakQsTUFBTSxLQUFLLEdBQW9CLG1CQUFDLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFN0MsMERBQTBEO0FBQzFELE1BQU0sU0FBUyxHQUFxQixJQUFJLEdBQUcsRUFBZSxDQUFDO0FBQzNELE1BQU0sZUFBZSxHQUFXLGlCQUFpQixDQUFDO0FBRWxEOzs7R0FHRztBQUNILE1BQU0sY0FBYyxHQUFHLENBQUMsWUFBb0IsRUFBVyxFQUFFO0lBQ3JELElBQUk7UUFDQSxNQUFNLEdBQUcsR0FBRywwQkFBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sT0FBTyxHQUFHLG1DQUFlLEVBQUUsQ0FBQztRQUVsQyxPQUFPLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDdkU7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLDZEQUE2RDtRQUM3RCxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFVCxPQUFPLElBQUksQ0FBQztLQUNmO0FBQ0wsQ0FBQyxDQUFDO0FBRUYsa0RBQWtEO0FBQ3JDLFFBQUEsYUFBYSxHQUFHLENBQUMsWUFBb0IsRUFBTyxFQUFFO0lBQ3ZELHVEQUF1RDtJQUN2RCxJQUFJLE9BQU8sR0FBUSxJQUFJ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