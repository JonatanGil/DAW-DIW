"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const parser = require('postcss-less');
const postcss = require("postcss");
const utils_debug_1 = require("@hint/utils-debug");
const utils_string_1 = require("@hint/utils-string");
const types_1 = require("hint/dist/src/lib/types");
const debug = utils_debug_1.debug(__filename);
class CSSParser extends types_1.Parser {
    constructor(engine) {
        super(engine, 'less');
        const emitLESS = async (code, resource, element) => {
            try {
                await this.engine.emitAsync(`parse::start::css`, { resource });
                const result = await postcss().process(code, { from: resource, parser });
                const ast = result.root; // always defined even for '' (typings error?)
                await this.engine.emitAsync(`parse::end::css`, {
                    ast,
                    code,
                    element,
                    resource
                });
            }
            catch (err) /* istanbul ignore next */ {
                debug(`Error parsing LESS code: ${code} - ${err}`);
            }
        };
        engine.on('fetch::end::*', async (fetchEnd) => {
            const code = fetchEnd.response.body.content;
            const mediaType = fetchEnd.response.mediaType;
            const resource = fetchEnd.resource;
            if (mediaType === 'text/less' || mediaType === 'text/x-less') {
                await emitLESS(code, resource, null);
            }
        });
        engine.on('element::style', async ({ element, resource }) => {
            const type = utils_string_1.normalizeString(element.getAttribute('type'));
            if (type === 'text/less' || type === 'text/x-less') {
                await emitLESS(element.innerHTML, resource, element);
            }
        });
    }
}
exports.default = CSSParser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUV2QyxtQ0FBbUM7QUFFbkMsbURBQStDO0FBQy9DLHFEQUFxRDtBQUVyRCxtREFBaUQ7QUFJakQsTUFBTSxLQUFLLEdBQUcsbUJBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUU1QixNQUFxQixTQUFVLFNBQVEsY0FBbUI7SUFDdEQsWUFBbUIsTUFBMkI7UUFDMUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUV0QixNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsSUFBWSxFQUFFLFFBQWdCLEVBQUUsT0FBMkIsRUFBRSxFQUFFO1lBRW5GLElBQUk7Z0JBQ0EsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7Z0JBRS9ELE1BQU0sTUFBTSxHQUFHLE1BQU0sT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztnQkFDekUsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUssQ0FBQyxDQUFDLDhDQUE4QztnQkFFeEUsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRTtvQkFDM0MsR0FBRztvQkFDSCxJQUFJO29CQUNKLE9BQU87b0JBQ1AsUUFBUTtpQkFDWCxDQUFDLENBQUM7YUFFTjtZQUFDLE9BQU8sR0FBRyxFQUFFLDBCQUEwQixDQUFDO2dCQUNyQyxLQUFLLENBQUMsNEJBQTRCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQyxDQUFDO2FBQ3REO1FBQ0wsQ0FBQyxDQUFDO1FBRUYsTUFBTSxDQUFDLEVBQUUsQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxFQUFFO1lBQzFDLE1BQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUM1QyxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQztZQUM5QyxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDO1lBRW5DLElBQUksU0FBUyxLQUFLLFdBQVcsSUFBSSxTQUFTLEtBQUssYUFBYSxFQUFFO2dCQUMxRCxNQUFNLFFBQVEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3hDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLGdCQUFnQixFQUFFLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsRUFBRSxFQUFFO1lBQ3hELE1BQU0sSUFBSSxHQUFHLDhCQUFlLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBRTNELElBQUksSUFBSSxLQUFLLFdBQVcsSUFBSSxJQUFJLEtBQUssYUFBYSxFQUFFO2dCQUNoRCxNQUFNLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQzthQUN4RDtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBMUNELDRCQTBDQyJ9